const fetch = require('node-fetch'); // Import the 'node-fetch' library for making API requests
const { DateTime } = require('luxon');

module.exports = function (eleventyConfig) {
	// adds the official eleventy navigation plugin for a scalable navigation
	eleventyConfig.addPlugin(require('@11ty/eleventy-navigation'));


	// allows assets, CMS files, and other root files to be passed into /public.
	// styles are automatically generated by LESS/SASS
	eleventyConfig.addPassthroughCopy('./src/assets');
	eleventyConfig.addPassthroughCopy('./src/admin');
	eleventyConfig.addPassthroughCopy('./src/_redirects');
	eleventyConfig.addPassthroughCopy({ './src/robots.txt': '/robots.txt' });
	eleventyConfig.addPassthroughCopy({ './src/sitemap.xml': '/sitemap.xml' });

	// normally, 11ty will render dates on blog posts in full JSDate format (Fri Dec 02 18:00:00 GMT-0600)
	// this filter allows dates to be converted into a normal, locale format.
	eleventyConfig.addFilter('postDate', (dateObj) => {
		return DateTime.fromJSDate(dateObj).toLocaleString(DateTime.DATE_MED);
	});
	eleventyConfig.addFilter('Date', (dateObj) => {
		return DateTime.fromISO(dateObj, { zone: 'utc' }).toLocaleString(DateTime.DATE_MED);
	});


	// Add the Hashnode API data as global data
	eleventyConfig.addGlobalData("apiData", async () => {
		try {
			const response = await fetch('https://gql.hashnode.com', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					query: `
            query {
              publication(host: "engineering.hashnode.com") {
                posts(first: 10) {
                  	edges {
						node {
							slug
							title
							brief
							url
							coverImage {
								url
							}
							author {
								name
								profilePicture
							}
							publishedAt
							content {
								html
							}
						}
                  	}
                }
              }
            }
          `
				})
			});
			const data = await response.json();
			console.log(data); // Log the retrieved data
			return data;
		} catch (error) {
			console.error(error);
			return {}; // Return an empty object if there's an error
		}
	});

	return {
		dir: {
			input: 'src',
			output: 'public',
			includes: '_includes',
			data: '_data',
		},
		htmlTemplateEngine: 'njk',
	};
};
